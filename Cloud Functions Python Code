import json
import requests
from datetime import datetime, timezone
from google.cloud import storage

API_URL = "https://api.frankfurter.app/latest"
BUCKET_NAME = "exchange_rate_api_bucket"

def call_api():
    response = requests.get(API_URL, timeout=10)
    response.raise_for_status()
    return response.json()

def main(request):
    data = call_api()

    output = {
        "ingestion_timestamp": datetime.now(timezone.utc).isoformat(),
        "base_currency": data["base"],
        "date": data["date"],
        "rates": data["rates"]
    }

    timestamp = datetime.now(timezone.utc).strftime("%Y%m%d_%H%M%S")
    filename = f"raw/exchange_rates/{timestamp}.json"

    client = storage.Client()
    bucket = client.bucket(BUCKET_NAME)
    blob = bucket.blob(filename)
    blob.upload_from_string(
        json.dumps(output),
        content_type="application/json"
    )

    return {
        "status": "success",
        "file_written": filename
    }
